<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Fifa | Cadastro</title>

  <script src="./js/sessao.js"></script>

  <link rel="stylesheet" href="css/estilo.css">
  <link rel="icon" href="css/imagens//FIFA-Logo.png">
  <link rel="preconnect" href="https://fonts.gstatic.com" />
</head>

<body>
  <!-- Navbar
    <div class="header">
        <div class="container">
            <ul class="navbar">
                <li><img onclick="imgnav()" src="./../projetoindividual/css/imagens/FIFA-Logo.png" alt=""></li>
                

            </ul>
        </div>
    </div> -->

  <!-- Fim navbar -->

  <div class="cadastro">
    <div class="alerta_erro">

    </div>
    <div class="container">
      <div class="card-cadastro">
        <h2 onclick="imgnav">Seja Bem-vindo ao site de <p> fifa </p>
        </h2>
        <div id="div_formulario" class="formulario">

          <!-- <div class="campo">
            <span>Código de ativação:</span>
            <input id="codigo_input" type="text" placeholder="Insira aqui seu código" />
          </div> -->
          <div class="campo">
            <span>Nome:</span>
            <input id="nome_input" type="text" placeholder="Seu nome" />
          </div>
          <div class="campo">
            <span>E-mail:</span>
            <input id="email_input" type="text" placeholder="meuemail@provedor.com" />
          </div>
          <div class="campo">
            <span>Senha:</span>
            <input id="senha_input" type="password" placeholder="******" />
          </div>
          <div class="campo">
            <span>Confirmação da Senha:</span>
            <input id="confirmacao_senha_input" type="password" placeholder="******" />
          </div>
          <div style="display: flex; justify-content: center;" id="cardErro"></div>
          <div id="mensagem_erro">

          </div>
          <button onclick="mostrar()" class="botao-quiz">Seguinte</button>
          <button class="botao-quiz" onclick="voltar()">Voltar para o inicio</button>


        </div>
        <div id="div_aguardar" class="loading-div">

        </div>

        <div id="div_erros_login"></div>
      </div>
    </div>
    <div>
      <!-- Início quiz -->
      <div id="quiz" class="header-quiz">

        <div id="container_quiz" class="container-quiz">
          <select class="select_time" onclick="mostrar()" id="select_time">
            <option selected disabled value="">Selecione seu time</option>
            <option value="1">Corinthians</option>
            <option value="2">Palmeiras</option>
            <option value="3">São paulo</option>
            <option value="4">Santos</option>
            <option value="5">Vasco</option>
            <option value="6">Flamengo</option>
            <option value="7">Fluminense</option>
            <option value="8">Cruzeiro</option>
            <option value="9">Grêmio</option>
            <option value="10">Internacional</option>

          </select>
          <div style="display: none;" id="div_corinthians">
            <p>Fundado em 1910, o Corinthians é um dos clubes mais populares e vitoriosos do Brasil, com uma vasta
              torcida.
              Tem grandes conquistas, como a Copa Libertadores de 2012 e o Mundial de Clubes da FIFA em 2000 e 2012. O
              time
              tem uma rivalidade histórica com o Palmeiras, Santos e São Paulo.</p>
            <img src="css/imagens/escudo-Corinthians.webp" alt="">
            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_palmeiras">
            <p>Fundado em 1914, o Palmeiras é um dos clubes mais bem-sucedidos do Brasil, com um grande número de
              títulos,
              incluindo a Copa Libertadores (2020, 2022). A rivalidade com o Corinthians é intensa, sendo um dos maiores
              clássicos do futebol paulista.</p>
            <img src="css/imagens/palmeiras.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_saopaulo">
            <p>Fundado em 1930, o São Paulo é um dos clubes mais prestigiados do Brasil, com vários títulos nacionais e
              internacionais, incluindo a Copa Libertadores e o Mundial de Clubes. Seu estádio, o Morumbi, é um dos
              maiores
              do país. A rivalidade com Palmeiras e Corinthians é histórica.</p>
            <img src="css/imagens/saopaulo.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_santos">
            <p>Fundado em 1912, o Santos é conhecido mundialmente por sua relação com Pelé, considerado o maior jogador
              de
              futebol de todos os tempos. O time possui uma das maiores torcidas do Brasil e uma rica história de
              títulos
              nacionais e internacionais.</p>
            <img src="css/imagens/santos.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_vasco">
            <p>Fundado em 1898, o Vasco é um dos clubes de maior tradição do Brasil, com uma enorme torcida e várias
              conquistas nacionais, como o Campeonato Brasileiro. A rivalidade com Flamengo e Fluminense é intensa,
              especialmente no Rio de Janeiro.</p>
            <img src="css/imagens/vasco.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_flamengo">
            <p>Fundado em 1895, o Flamengo é um dos clubes mais populares e vitoriosos do Brasil, com uma base de fãs
              espalhada por todo o país. O time tem uma rivalidade histórica com o Fluminense, Vasco e Botafogo, e já
              conquistou inúmeros títulos, incluindo a Copa Libertadores e o Mundial de Clubes.</p>
            <img src="css/imagens/flamengo.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_fluminense">
            <p>Fundado em 1902, o Fluminense é um dos clubes mais tradicionais do Brasil, com uma grande história no
              futebol. O time tem uma grande rivalidade com Flamengo e Vasco. O Fluminense é conhecido por seu estilo de
              jogo técnico e por suas grandes gerações de jogadores.</p>
            <img src="css/imagens/fluminense.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_cruzeiro">
            <p>Fundado em 1921, o Cruzeiro é um dos clubes mais vitoriosos de Minas Gerais e do Brasil. Com várias
              conquistas nacionais e internacionais, o Cruzeiro tem uma grande base de torcedores e rivaliza com times
              como
              Atlético-MG e Flamengo.</p>
            <img src="css/imagens/cruzeiro.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_gremio">
            <p>Fundado em 1903, o Grêmio é um dos clubes mais tradicionais do Brasil, com uma forte base de torcedores
              no
              sul do país. O time tem uma grande história de títulos nacionais e internacionais, incluindo a Copa
              Libertadores.</p>
            <img src="css/imagens/gremio.webp" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div style="display: none;" id="div_internacional">
            <p>Fundado em 1909, o Internacional, também conhecido como Inter, é um dos maiores clubes do sul do Brasil.
              Com
              várias conquistas nacionais e internacionais, incluindo a Copa Libertadores e o Mundial de Clubes, o time
              tem
              uma rivalidade forte com o Grêmio no clássico "Grenal".</p>
            <img src="css/imagens/internacional.png" alt="">

            <button class="div-times" onclick="selecionar()">Selecionar time</button>
          </div>
          <div class="perguntas-quiz" id="perguntas1_div">
            <span>Vai ao estádio do seu time uma vez ao mês?</span>
            <select class="div-times" onchange="proxima()" id="select_pergunta1">
              <option selected disabled value="">Selecione uma opção</option>
              <option value="0">Não</option>
              <option value="20">Sim</option>

            </select>

          </div>

          <div class="perguntas-quiz" id="perguntas2_div">
            <span>Segue jogadores ou clubes nas redes sociais?</span>
            <select class="div-times" onchange="proxima2()" id="select_pergunta2">
              <option selected disabled value="">Selecione uma opção</option>
              <option value="0">Não</option>
              <option value="20">Sim</option>
            </select>

          </div>

          <div class="perguntas-quiz" id="perguntas3_div">
            <span>Assiste aos jogos do seu time toda semana?</span>
            <select class="div-times" onchange="proxima3()" id="select_pergunta3">
              <option selected disabled value="">Selecione uma opção</option>
              <option value="0">Não</option>
              <option value="20">Sim</option>
            </select>

          </div>

          <div class="perguntas-quiz" id="perguntas4_div">
            <span>Já fez parte de alguma torcida organizada?</span>
            <select class="div-times" onchange="proxima4()" id="select_pergunta4">
              <option selected disabled value="">Selecione uma opção</option>
              <option value="0">Não</option>
              <option value="20">Sim</option>
            </select>

          </div>

          <div class="perguntas-quiz" id="perguntas5_div">
            <span>Já participou de algum programa de sócio-torcedor?</span>
            <select class="div-times" id="select_pergunta5">
              <option selected disabled value="">Selecione uma opção</option>
              <option value="0">Não</option>
              <option value="20">Sim</option>
            </select>
            <button id="button_cadastro" class="botao" onclick="cadastrar()">Cadastrar</button>

          </div>
        </div>

      </div>
    </div>
  </div>


  <!--footer inicio-->
  <!-- <div class="footer">
    <div class="container">
      <h4>Feito com amor por Gabriel Senna, SPTech &copy; 2025</h4>
      <span class="version">v1.0.0</span>
    </div>
  </div> -->
  <!--footer fim-->
</body>

</html>

<script>
  function voltar() {
    window.location.href = 'index.html';
  }


  function mostrar() {
    var select = select_time.value;
    var nomeVar = nome_input.value;
    var emailVar = email_input.value;
    var senhaVar = senha_input.value;
    var confirmacaoSenhaVar = confirmacao_senha_input.value;
    timeEscolhido = select;

    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == ""
    ) {
      cardErro.innerHTML = `<p style="color: red;"> Todos os campos estão vazios</p>`
      finalizarAguardar();
      return false;
    }


    div_formulario.style.display = 'none';
    select_time.style.display = 'block';
    container_quiz.style.display = 'block';
    if (select == '1') {
      div_corinthians.style.display = 'block'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '2') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'block'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '3') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'block'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '4') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'block'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '5') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'block'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '6') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'block'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '7') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'block'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '8') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'block'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'none'
    }
    if (select == '9') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'block'
      div_internacional.style.display = 'none'
    }
    if (select == '10') {
      div_corinthians.style.display = 'none'
      div_palmeiras.style.display = 'none'
      div_saopaulo.style.display = 'none'
      div_santos.style.display = 'none'
      div_vasco.style.display = 'none'
      div_flamengo.style.display = 'none'
      div_fluminense.style.display = 'none'
      div_cruzeiro.style.display = 'none'
      div_gremio.style.display = 'none'
      div_internacional.style.display = 'block'
    }
  }


  function selecionar() {

    var pergunta1 = select_pergunta1.value;

    var pergunta3 = select_pergunta3.value;
    var pergunta4 = select_pergunta4.value;
    var pergunta5 = select_pergunta5.value;
    select_time.style.display = 'none'
    div_corinthians.style.display = 'none'
    div_palmeiras.style.display = 'none'
    div_saopaulo.style.display = 'none'
    div_santos.style.display = 'none'
    div_vasco.style.display = 'none'
    div_flamengo.style.display = 'none'
    div_fluminense.style.display = 'none'
    div_cruzeiro.style.display = 'none'
    div_gremio.style.display = 'none'
    div_internacional.style.display = 'none'

    perguntas1_div.style.display = 'block'
    select_pergunta1.style.display = 'block'

  }
  function proxima() {
    select_time.style.display = 'none'

    perguntas1_div.style.display = 'none'
    select_pergunta1.style.display = 'none'
    perguntas2_div.style.display = 'block'
    select_pergunta2.style.display = 'block'

  }
  function proxima2() {
    var pergunta2 = select_pergunta2.value;
    select_time.style.display = 'none'

    perguntas2_div.style.display = 'none'
    select_pergunta2.style.display = 'none'
    perguntas3_div.style.display = 'block'
    select_pergunta3.style.display = 'block'

  }
  function proxima3() {
    var pergunta3 = select_pergunta2.value;
    select_time.style.display = 'none'

    perguntas3_div.style.display = 'none'
    select_pergunta3.style.display = 'none'
    perguntas4_div.style.display = 'block'
    select_pergunta4.style.display = 'block'

  }
  function proxima4() {
    var pergunta4 = select_pergunta2.value;
    select_time.style.display = 'none'

    perguntas4_div.style.display = 'none'
    select_pergunta4.style.display = 'none'
    perguntas5_div.style.display = 'block'
    select_pergunta5.style.display = 'block'
    button_cadastro.style.display = 'block'

  }







  function imgnav() {
    window.location.href = 'index.html';
  }


 function cadastrar() {
  var nomeVar = nome_input.value;
  var emailVar = email_input.value;
  var senhaVar = senha_input.value;
  var confirmacaoSenhaVar = confirmacao_senha_input.value;
  var timeEscolhidoVar = select_time.value;
   // calcula a pontuação (usa sua função existente)
const pontuacaoFinal = calcularPontuacaoFinal(); // <-- certifique-se que essa função existe

fetch("/usuarios/cadastrar", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    nomeServer: nomeVar,
    emailServer: emailVar,
    senhaServer: senhaVar,
    timeServer: Number(timeEscolhidoVar), 
    p1: Number(select_pergunta1.value),
    p2: Number(select_pergunta2.value),
    p3: Number(select_pergunta3.value),
    p4: Number(select_pergunta4.value),
    p5: Number(select_pergunta5.value),
    nivel: Number(pontuacaoFinal) 
  })
})
.then(async (res) => {
  const ct = res.headers.get("content-type") || "";
  const body = ct.includes("application/json") ? await res.json() : await res.text();

  if (res.ok) {
    mensagem_erro.innerHTML = "Cadastro realizado! Redirecionando...";
    setTimeout(() => (window.location = "login.html"), 2000);
  } else {
    throw new Error(typeof body === "string" ? body : JSON.stringify(body));
  }
})
.catch((err) => {
  mensagem_erro.innerHTML = err.message || err;
});


  if (
    nomeVar == "" ||
    emailVar == "" ||
    senhaVar == "" ||
    confirmacaoSenhaVar == ""
  ) {
    cardErro.innerHTML = `<p style="color: red;">Todos os campos devem ser preenchidos</p>`;
    return false;
  }

  if (!emailVar.includes("@") || !emailVar.includes(".")) {
    cardErro.innerHTML = `<p style="color: red;">Digite um e-mail válido.</p>`;
    return false;
  }

  if (senhaVar !== confirmacaoSenhaVar) {
    cardErro.innerHTML = `<p style="color: red;">As senhas não coincidem.</p>`;
    return false;
  }

 


}




  // calcula e retorna pontuação final (sem side-effects)
function calcularPontuacaoFinal() {
  const total =
    Number(select_pergunta1.value) +
    Number(select_pergunta2.value) +
    Number(select_pergunta3.value) +
    Number(select_pergunta4.value) +
    Number(select_pergunta5.value);

  return total;
}

// salva no backend (retorna a Promise)
function salvarNivel() {
  const pontuacao = calcularPontuacaoFinal();
  const id = sessionStorage.ID_USUARIO;

  fetch("/usuarios/salvarNivel", {
    method: "PUT",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      idUsuario: id,
      nivel: pontuacao   // <-- AGORA ESTÁ CORRETO
    })
  })
  .then(res => res.json())
  .then(console.log)
  .catch(console.error);
}


// fluxo final: calcula → salva → atualiza KPIs (exemplo)
function finalizarQuizEAtualizar() {
  const pontuacaoFinal = calcularPontuacaoFinal();
  console.log("Pontuação final:", pontuacaoFinal);

  // Salva e, em seguida, solicita as KPIs atualizadas
  salvarNivel(pontuacaoFinal)
    .then(respSalvar => {
      console.log("Nivel salvo:", respSalvar);

      // atualizar média geral
      return fetch("/usuarios/kpi/media");
    })
    .then(resMedia => {
      if (!resMedia.ok) throw new Error("Erro na API média: " + resMedia.status);
      return resMedia.json();
    })
    .then(dadosMedia => {
      console.log("Média de nível geral:", dadosMedia[0]?.mediaNivel ?? dadosMedia.media ?? dadosMedia);
      // atualizar KPI na tela, ex:
      const mediaValor = dadosMedia[0]?.mediaNivel ?? dadosMedia.media ?? "--";
      document.getElementById("kpi_media").innerText = mediaValor;
      // agora buscar nível do usuário
      return fetch(`/usuarios/kpi/usuario/${sessionStorage.ID_USUARIO}`);
    })
    .then(resUsuario => {
      if (!resUsuario.ok) throw new Error("Erro na API kpi usuario: " + resUsuario.status);
      return resUsuario.json();
    })
    .then(dadosUsuario => {
      const nivel = dadosUsuario[0]?.nivelTorcedor ?? dadosUsuario.nivelTorcedor ?? dadosUsuario.nivel ?? "--";
      console.log("Seu nível:", nivel);
      document.getElementById("kpi_usuario").innerText = nivel;
    })
    .catch(err => {
      console.error("Erro no fluxo de salvar/atualizar KPIs:", err);
    });
}


</script>